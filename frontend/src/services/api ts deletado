// ============================================================
// api.ts â€” IntegraÃ§Ã£o central com o backend Flask (Partiu085)
// VERSÃƒO CORRIGIDA PARA PRODUÃ‡ÃƒO (RENDER)
// ============================================================

// 1. Tenta pegar do .env da Vercel.
// 2. Se nÃ£o tiver, usa o endereÃ§o REAL do Render (nÃ£o o localhost!)
const BASE_URL = import.meta.env.VITE_API_URL || "https://partiu085-api.onrender.com";

// FunÃ§Ã£o auxiliar genÃ©rica de requisiÃ§Ã£o
async function request(endpoint: string, options: RequestInit = {}) {
  try {
    // Remove barra extra se tiver duplicada
    // Ex: BASE_URL termina com / e endpoint comeÃ§a com /
    const url = `${BASE_URL.replace(/\/$/, '')}${endpoint}`;

    console.log(`ğŸ“¡ RequisiÃ§Ã£o para: ${url}`); // Log para debug

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000); // Aumentei para 30s (Render Ã© lento as vezes)

    const response = await fetch(url, {
      headers: { "Content-Type": "application/json" },
      signal: controller.signal,
      ...options,
    });

    clearTimeout(timeout);

    if (!response.ok) throw new Error(`Erro HTTP ${response.status}`);
    return await response.json();
  } catch (error) {
    console.error(`âŒ Erro em ${endpoint}:`, error);
    return { sucesso: false, mensagem: "Erro de conexÃ£o com o backend." };
  }
}

// ============================================================
// ğŸ”¹ ExecuÃ§Ã£o principal â€” Varredura Amadeus
// ============================================================
export async function executarRadar(body?: any) {
  console.log("ğŸš€ Executando varredura personalizada via /api/executar...");
  // Nota: O Python espera snake_case (data_ida), garanta que o body esteja certo
  return await request("/api/executar", {
    method: "POST",
    body: JSON.stringify(body || { modo: "AUTO" }),
  });
}

// ============================================================
// ğŸ”¹ Resultados â€” Ãšltimos voos detectados
// ============================================================
export async function getResultados() {
  console.log("ğŸ“Š Carregando resultados via /api/resultados...");
  return await request("/api/resultados");
}

// ============================================================
// ğŸ”¹ Status do radar (em uso futuro no painel)
// ============================================================
export async function getStatusRadar() {
  return await request("/api/status_radar");
}

// ============================================================
// ğŸ”¹ Teste de conexÃ£o com Telegram
// ============================================================
export async function testarTelegram() {
  return await request("/api/test_telegram");
}

// ============================================================
// ğŸ”¹ Teste de conexÃ£o com Amadeus
// ============================================================
export async function testarAmadeus() {
  return await request("/api/test_amadeus");
}